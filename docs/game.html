<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>模写 - ゲーム</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .split { display:flex; justify-content:center; gap:30px; flex-wrap:wrap; margin:20px 0; }
    .area { border:2px solid #bdc3c7; padding:10px; border-radius:8px; background:white; }
    canvas { border:1px solid #34495e; background:#fff; touch-action:none; }
    .controls button { margin:8px; padding:10px 25px; font-size:1.1rem; border:none; border-radius:6px; cursor:pointer; }
    #clear  { background:#e74c3c; color:white; }
    #finish { background:#3498db; color:white; }
    #home   { background:#7f8c8d; color:white; }
  </style>
</head>
<body>

  <h2 id="title">模写ゲーム</h2>

  <div class="split">
    <div class="area">
      <h3>お題</h3>
      <canvas id="ref" width="380" height="480"></canvas>
    </div>
    <div class="area">
      <h3>ここに描いてください</h3>
      <canvas id="draw" width="380" height="480"></canvas>
    </div>
  </div>

  <div class="controls">
    <button id="clear">クリア</button>
    <button id="finish">完了して判定</button>
    <button id="home">ホームに戻る</button>
  </div>

<script>
// ========== お題データ（黒線のみ） ==========
const levels = {
  easy: [
    {type:"circle",   x:190, y:240, r:110, color:"#000000", lineWidth:6},
    {type:"rect",     x:190, y:240, w:220, h:220, color:"#000000", lineWidth:6},
    {type:"triangle", x:190, y:240, size:180, color:"#000000", lineWidth:6}
  ],
  medium: [
    {type:"circle",   x:190, y:220, r:130, color:"#000000", lineWidth:6},
    {type:"star",     x:190, y:260, r:100, points:5, color:"#000000", lineWidth:6}
  ],
  hard: [
    {type:"star",     x:190, y:240, r:140, points:5, color:"#000000", lineWidth:6},
    {type:"circle",   x:170, y:220, r:90,  color:"#000000", lineWidth:6},
    {type:"rect",     x:210, y:260, w:180, h:180, color:"#000000", lineWidth:6}
  ]
};

// ========== 描画ヘルパー（線のみ） ==========
const refCanvas = document.getElementById("ref");
const drawCanvas = document.getElementById("draw");
const ctxRef  = refCanvas.getContext("2d");
const ctxDraw = drawCanvas.getContext("2d");

// お題の描画（塗りつぶしなし・線のみ）
function drawCircle(ctx, x, y, r, color, lineWidth) {
  ctx.strokeStyle = color;
  ctx.lineWidth = lineWidth;
  ctx.beginPath();
  ctx.arc(x, y, r, 0, Math.PI*2);
  ctx.stroke();
}

function drawRect(ctx, x, y, w, h, color, lineWidth) {
  ctx.strokeStyle = color;
  ctx.lineWidth = lineWidth;
  ctx.strokeRect(x-w/2, y-h/2, w, h);
}

function drawTriangle(ctx, x, y, size, color, lineWidth) {
  ctx.strokeStyle = color;
  ctx.lineWidth = lineWidth;
  ctx.beginPath();
  const height = size * Math.sqrt(3) / 2;   
  ctx.moveTo(x, y - height * 0.666);  
  ctx.lineTo(x - size / 2, y + height * 0.333);
  ctx.lineTo(x + size / 2, y + height * 0.333);
  ctx.closePath();
  ctx.stroke();
}

function drawStar(ctx, x, y, r, points, color, lineWidth) {
  ctx.strokeStyle = color;
  ctx.lineWidth = lineWidth;
  ctx.beginPath();
  for (let i = 0; i < points*2; i++) {
    const angle = (Math.PI / points) * i + Math.PI/2;
    const radius = (i % 2 === 0) ? r : r*0.4;
    ctx.lineTo(x + Math.cos(angle)*radius, y + Math.sin(angle)*radius);
  }
  ctx.closePath();
  ctx.stroke();
}

function drawShape(ctx, shape) {
  const {type, x, y, color, lineWidth = 6} = shape;
  switch(type) {
    case "circle":   drawCircle  (ctx, x, y, shape.r,     color, lineWidth); break;
    case "rect":     drawRect    (ctx, x, y, shape.w, shape.h, color, lineWidth); break;
    case "triangle": drawTriangle(ctx, x, y, shape.size,  color, lineWidth); break;
    case "star":     drawStar    (ctx, x, y, shape.r, shape.points, color, lineWidth); break;
  }
}

// ========== ゲーム初期化 ==========
const level = localStorage.getItem("level") || "easy";
document.getElementById("title").textContent = `難易度：${{easy:"初級",medium:"中級",hard:"上級"}[level]}`;

levels[level].forEach(s => drawShape(ctxRef, s));

// ========== ユーザーの描画（線でつなぐ） ==========
let drawing = false;
let lastX = null;
let lastY = null;

function getPos(e) {
  const rect = drawCanvas.getBoundingClientRect();
  const clientX = e.clientX ?? (e.touches && e.touches[0] ? e.touches[0].clientX : null);
  const clientY = e.clientY ?? (e.touches && e.touches[0] ? e.touches[0].clientY : null);
  if (clientX === null || clientY === null) return null;
  return {
    x: clientX - rect.left,
    y: clientY - rect.top
  };
}

function drawLine(e) {
  if (!drawing) return;
  e.preventDefault();
  const pos = getPos(e);
  if (!pos) return;

  ctxDraw.strokeStyle = "#000000";
  ctxDraw.lineWidth = 12;          // 線の太さ（好みで変更）
  ctxDraw.lineCap = "round";       // 線端を丸く
  ctxDraw.lineJoin = "round";

  if (lastX !== null && lastY !== null) {
    ctxDraw.beginPath();
    ctxDraw.moveTo(lastX, lastY);
    ctxDraw.lineTo(pos.x, pos.y);
    ctxDraw.stroke();
  }

  lastX = pos.x;
  lastY = pos.y;
}

function startDrawing(e) {
  drawing = true;
  const pos = getPos(e);
  if (pos) {
    lastX = pos.x;
    lastY = pos.y;
  }
}

function stopDrawing() {
  drawing = false;
  lastX = null;
  lastY = null;
}

// イベント登録
drawCanvas.addEventListener("mousedown", startDrawing);
drawCanvas.addEventListener("mousemove", drawLine);
drawCanvas.addEventListener("mouseup", stopDrawing);
drawCanvas.addEventListener("mouseout", stopDrawing);

drawCanvas.addEventListener("touchstart", startDrawing);
drawCanvas.addEventListener("touchmove", drawLine);
drawCanvas.addEventListener("touchend", stopDrawing);
drawCanvas.addEventListener("touchcancel", stopDrawing);

// ========== ボタン ==========
document.getElementById("clear").onclick = () => {
  ctxDraw.clearRect(0, 0, drawCanvas.width, drawCanvas.height);
};

document.getElementById("finish").onclick = () => {
  const sim = compareCanvases();
  localStorage.setItem("lastScore", sim);
  window.location.href = "result.html";
};

document.getElementById("home").onclick = () => {
  window.location.href = "index.html";
};

// ========== 一致度計算（線なので少し甘めに） ==========
function compareCanvases() {
  const w = drawCanvas.width;
  const h = drawCanvas.height;
  const refData  = ctxRef.getImageData(0, 0, w, h).data;
  const drawData = ctxDraw.getImageData(0, 0, w, h).data;
  
  let score = 0;
  let total = 0;

  for (let i = 0; i < refData.length; i += 4) {
    const refA = refData[i+3];
    if (refA < 30) continue;     // お題の線部分以外は無視

    total++;
    const drawR = drawData[i];
    const drawG = drawData[i+1];
    const drawB = drawData[i+2];
    const drawA = drawData[i+3];

    // 黒に近い色が描かれていればOK（多少のズレを許容）
    if (drawA > 80 && drawR < 100 && drawG < 100 && drawB < 100) {
      score++;
    }
  }

  if (total === 0) return 0;
  // 少し寛容にして最大120%くらいまで出るように（完全一致しづらいので）
  return Math.min(100, Math.round(score / total * 130));
}
  </script>

</body>
</html>