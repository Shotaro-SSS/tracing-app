<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>模写 - ゲーム</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .split { display:flex; justify-content:center; gap:30px; flex-wrap:wrap; margin:20px 0; }
    .area { border:2px solid #bdc3c7; padding:10px; border-radius:8px; background:white; }
    canvas { border:1px solid #34495e; background:#fff; touch-action:none; }
    .controls button { margin:8px; padding:10px 25px; font-size:1.1rem; border:none; border-radius:6px; cursor:pointer; }
    #clear  { background:#e74c3c; color:white; }
    #finish { background:#3498db; color:white; }
    #home   { background:#7f8c8d; color:white; }
  </style>
</head>
<body>

  <h2 id="title">模写ゲーム</h2>

  <div class="split">
    <div class="area">
      <h3>お題</h3>
      <canvas id="ref" width="380" height="480"></canvas>
    </div>
    <div class="area">
      <h3>ここに描いてください</h3>
      <canvas id="draw" width="380" height="480"></canvas>
    </div>
  </div>

  <div class="controls">
    <button id="clear">クリア</button>
    <button id="finish">完了して判定</button>
    <button id="home">ホームに戻る</button>
  </div>

  <script>
// ========== お題データ ==========
const levels = {
  easy: [
    {type:"circle",   x:190, y:240, r:110, color:"#e74c3c"},
    {type:"rect",     x:190, y:240, w:220, h:220, color:"#3498db"},
    {type:"triangle", x:190, y:240, size:180, color:"#2ecc71"}
  ],
  medium: [
    {type:"circle",   x:190, y:220, r:130, color:"#9b59b6"},
    {type:"star",     x:190, y:260, r:100, points:5, color:"#f1c40f"}
  ],
  hard: [
    {type:"star",     x:190, y:240, r:140, points:5, color:"#e74c3c"},
    {type:"circle",   x:170, y:220, r:90,  color:"#3498db", alpha:0.7},
    {type:"rect",     x:210, y:260, w:180, h:180, color:"#2ecc71", alpha:0.6}
  ]
};

// ========== 描画ヘルパー ==========
const refCanvas = document.getElementById("ref");
const drawCanvas = document.getElementById("draw");
const ctxRef = refCanvas.getContext("2d");
const ctxDraw = drawCanvas.getContext("2d");

function drawCircle(ctx, x, y, r, color, alpha=1) {
  ctx.globalAlpha = alpha;
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.arc(x, y, r, 0, Math.PI*2);
  ctx.fill();
}

function drawRect(ctx, x, y, w, h, color, alpha=1) {
  ctx.globalAlpha = alpha;
  ctx.fillStyle = color;
  ctx.fillRect(x-w/2, y-h/2, w, h);
}

function drawTriangle(ctx, x, y, size, color, alpha = 1) {
  ctx.globalAlpha = alpha;
  ctx.fillStyle = color;
  ctx.beginPath();
  const h = size * Math.sqrt(3) / 2;  // 正三角形の高さ
  ctx.moveTo(x,          y - h);                // 上の頂点
  ctx.lineTo(x - size/2, y + h/3);              // 左下
  ctx.lineTo(x + size/2, y + h/3);              // 右下
  ctx.closePath();
  ctx.fill();
}

function drawStar(ctx, x, y, r, points, color, alpha=1) {
  ctx.globalAlpha = alpha;
  ctx.fillStyle = color;
  ctx.beginPath();
  for (let i = 0; i < points*2; i++) {
    const angle = (Math.PI / points) * i + Math.PI/2;
    const radius = (i % 2 === 0) ? r : r*0.4;
    ctx.lineTo(x + Math.cos(angle)*radius, y + Math.sin(angle)*radius);
  }
  ctx.closePath();
  ctx.fill();
}

function drawShape(ctx, shape) {
  const {type, x, y, color, alpha=1} = shape;
  switch(type) {
    case "circle":   drawCircle(ctx, x, y, shape.r, color, alpha); break;
    case "rect":     drawRect(ctx, x, y, shape.w, shape.h, color, alpha); break;
    case "triangle": drawTriangle(ctx, x, y, shape.size, color, alpha); break;
    case "star":     drawStar(ctx, x, y, shape.r, shape.points, color, alpha); break;
  }
}

// ========== ゲーム初期化 ==========
const level = localStorage.getItem("level") || "easy";
document.getElementById("title").textContent = `難易度：${{easy:"初級",medium:"中級",hard:"上級"}[level]}`;

levels[level].forEach(s => drawShape(ctxRef, s));

// ========== 描画ロジック ==========
let drawing = false;

function getPos(e) {
  const rect = drawCanvas.getBoundingClientRect();
  const clientX = e.clientX ?? e.touches[0].clientX;
  const clientY = e.clientY ?? e.touches[0].clientY;
  return {
    x: clientX - rect.left,
    y: clientY - rect.top
  };
}

function draw(e) {
  if (!drawing) return;
  e.preventDefault();
  const pos = getPos(e);
  ctxDraw.fillStyle = "#000000";
  ctxDraw.beginPath();
  ctxDraw.arc(pos.x, pos.y, 10, 0, Math.PI*2);
  ctxDraw.fill();
}

drawCanvas.addEventListener("mousedown", e=>{drawing=true; draw(e);});
drawCanvas.addEventListener("mousemove", draw);
drawCanvas.addEventListener("mouseup",   ()=>drawing=false);
drawCanvas.addEventListener("mouseout",  ()=>drawing=false);

drawCanvas.addEventListener("touchstart", e=>{drawing=true; draw(e);});
drawCanvas.addEventListener("touchmove",  draw);
drawCanvas.addEventListener("touchend",   ()=>drawing=false);

// ========== ボタン ==========
document.getElementById("clear").onclick = () => {
  ctxDraw.clearRect(0,0,drawCanvas.width,drawCanvas.height);
};

document.getElementById("finish").onclick = () => {
  const sim = compareCanvases();
  localStorage.setItem("lastScore", sim);
  window.location.href = "result.html";
};

document.getElementById("home").onclick = () => {
  window.location.href = "index.html";
};

// ========== 簡易一致度計算 ==========
function compareCanvases() {
  const w = drawCanvas.width, h = drawCanvas.height;
  const refData  = ctxRef.getImageData(0,0,w,h).data;
  const drawData = ctxDraw.getImageData(0,0,w,h).data;
  
  let score = 0;
  let total = 0;

  for (let i = 0; i < refData.length; i += 4) {
    const refA = refData[i+3];
    if (refA < 20) continue;  // お題の透明部分は無視

    total++;
    const drawA = drawData[i+3];
    if (drawA > 50) score++;   // 描いた場所に何かしら塗られていればOK（色無視）
  }

  return total > 0 ? Math.min(100, Math.round(score / total * 120)) : 0;  // 少し甘めに
}
  </script>
</body>
</html>